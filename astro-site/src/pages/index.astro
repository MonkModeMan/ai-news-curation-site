---
// src/pages/index.astro
import Layout from "../layouts/Layout.astro";
import ArticleCard from "../components/ArticleCard.astro";
import { getCollection } from "astro:content";

const PAGE_SIZE = 30;
const currentPage = 1;
const sort = "date";

const q = Astro.url?.searchParams.get("q")?.toLowerCase().trim() ?? "";
const media = Astro.url?.searchParams.get("media")?.toLowerCase().replace(/\s+/g, "").trim() ?? "";

console.log("🔍 index.astro loaded");
console.log("クエリパラメータ q =", q, "media =", media);

const allPosts = await getCollection("posts");
console.log("取得件数 allPosts =", allPosts.length);

const filteredPosts = allPosts.filter(post => {
  const title = post.data.title?.toLowerCase() ?? "";
  const desc = post.data.description?.toLowerCase() ?? "";
  const body = post.body?.toLowerCase() ?? "";
  const source = post.data.source?.toLowerCase().replace(/\s+/g, "") ?? "";

  const matchQ = !q || title.includes(q) || desc.includes(q) || body.includes(q);
  const matchMedia = !media || source.includes(media);

  return matchQ && matchMedia;
});

console.log("フィルタ後 filteredPosts =", filteredPosts.length);

const sortedPosts = [...filteredPosts].sort(
  (a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);

const paginatedPosts = sortedPosts;
const totalPages = 1;
const hasResults = paginatedPosts.length > 0;
---

<!-- ✅ 検索中オーバーレイ -->
<div id="search-overlay"
    class="fixed inset-0 z-50 bg-white/80 backdrop-blur-sm flex items-center justify-center text-xl font-bold text-red-600"
    style="display: none;"
    data-has-results={hasResults}>
  🔍 検索中です… 少々お待ちください
</div>

<Layout currentPage={currentPage} totalPages={totalPages} sort={sort} q={q} media={media}>
  <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {paginatedPosts.map((post) => (
      <ArticleCard
        title={post.data.title}
        pubDate={post.data.pubDate}
        description={post.data.description}
        media={post.data.source}
        thumbnail={post.data.thumbnail}
        url={post.data.url}
      />
    ))}
  </div>
</Layout>

<!-- ✅ search.js 読み込み -->
<script src="/ai-news-curation-site/search.js?v=20250624" defer></script>
