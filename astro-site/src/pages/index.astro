---
// /pages/index.astro
// üè† FlipboardÈ¢® ‰∏ÄË¶ß„Éö„Éº„Ç∏Ôºà1„Éö„Éº„Ç∏ÁõÆÔºâ
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import ArticleCard from "../components/ArticleCard.astro";

const PAGE_SIZE = 30;
const allPosts = await getCollection("posts");

// ‚úÖ Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÅÆÂèñÂæóÔºà„ÇØ„Ç®„É™„Éë„É©„É°„Éº„ÇøÔºâ
const search = new URL(Astro.request.url).searchParams.get("q")?.toLowerCase() ?? "";

// ‚úÖ „Éï„Ç£„É´„ÇøÂá¶ÁêÜÔºötitle„Éªdescription„Éªbody „Å´Âê´„Åæ„Çå„Çã„Åã
const filteredPosts = allPosts.filter(post =>
  post.data.title.toLowerCase().includes(search) ||
  post.data.description.toLowerCase().includes(search) ||
  (post.body && post.body.toLowerCase().includes(search))
);

// ‚úÖ ÊäïÁ®øÊó•ÈôçÈ†Ü„Åß„ÇΩ„Éº„Éà„Åó„Å¶„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥
const sorted = [...filteredPosts].sort(
  (a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);
const paginatedPosts = sorted.slice(0, PAGE_SIZE);
const totalPages = Math.ceil(sorted.length / PAGE_SIZE);
---

<Layout currentPage={1} totalPages={totalPages} sort="date">
  <form method="GET" class="mb-4">
    <input
      type="text"
      name="q"
      value={search}
      placeholder="Ë®ò‰∫ãÊ§úÁ¥¢"
      class="text-sm border rounded px-2 py-1 w-full sm:w-72"
    />
  </form>

  <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {paginatedPosts.map((post) => (
      <ArticleCard
        title={post.data.title}
        pubDate={post.data.pubDate}
        description={post.data.description}
        media={post.data.source}
        thumbnail={post.data.thumbnail}
        url={post.data.url}
      />
    ))}
  </div>

  {totalPages > 1 && (
    <div class="mt-8 flex justify-end text-sm text-blue-600">
      <a href="/ai-news-curation-site/page/date/2" class="hover:underline">
        Ê¨°„ÅÆ„Éö„Éº„Ç∏ ‚Üí
      </a>
    </div>
  )}
</Layout>