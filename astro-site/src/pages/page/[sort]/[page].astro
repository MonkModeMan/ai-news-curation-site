---
// [sort]/[page].astro 一覧ページ：GitHubPages対応
import "../../../styles/global.css";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const PAGE_SIZE = 30;
  const allPosts = await getCollection("posts");

  const sorts = ["date", "source"];
  const paths = [];

  for (const sort of sorts) {
    const sorted = sort === "source"
      ? [...allPosts].sort((a, b) => a.data.source.localeCompare(b.data.source))
      : [...allPosts].sort((a, b) => new Date(b.data.pubDate) - new Date(a.data.pubDate));

    const totalPages = Math.ceil(sorted.length / PAGE_SIZE);
    for (let i = 1; i <= totalPages; i++) {
      paths.push({ params: { sort, page: String(i) } });
    }
  }

  return paths;
}

const PAGE_SIZE = 30;
const { sort = "date", page } = Astro.params;
const currentPage = parseInt(page);
const base = Astro.site?.pathname ?? '';

const allPosts = await getCollection("posts");
const sortedPosts = sort === "source"
  ? allPosts.sort((a, b) => a.data.source.localeCompare(b.data.source))
  : allPosts.sort((a, b) => new Date(b.data.pubDate) - new Date(a.data.pubDate));

const start = (currentPage - 1) * PAGE_SIZE;
const end = start + PAGE_SIZE;
const posts = sortedPosts.slice(start, end);
const totalPages = Math.ceil(sortedPosts.length / PAGE_SIZE);
---

<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>AIニュースまとめ - ページ {currentPage}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body class="bg-gray-100 text-gray-800 font-sans px-4 py-6">
    <div class="max-w-6xl mx-auto">

      <!-- タイトル -->
      <header class="mb-8 text-center">
        <h1 class="text-6xl font-extrabold leading-tight tracking-tight">
          <a href={`${base}/page/date/1`} class="no-underline text-sky-400 hover:text-sky-600 active:text-sky-600">
            🤖 最新AIニュースまとめ
          </a>
        </h1>
        <div class="text-gray-600 text-lg mt-2">
          (ページ {currentPage} / 全 {totalPages} ページ中)
        </div>

        <!-- 並び順切替 -->
        <div class="text-gray-500 text-sm mt-1">
          並び順：
          {sort === "date" ? (
            <a href={`${base}/page/date/1`} class="inline-block px-2 py-1 rounded border font-bold text-sky-700 border-sky-300 bg-sky-50">
              新着順（投稿日が新しい順）
            </a>
          ) : (
            <a href={`${base}/page/date/1`} class="inline-block px-2 py-1 rounded border text-gray-400 hover:text-sky-600 hover:border-sky-200">
              新着順（投稿日が新しい順）
            </a>
          )}
          <span class="mx-2">|</span>
          {sort === "source" ? (
            <a href={`${base}/page/source/1`} class="inline-block px-2 py-1 rounded border font-bold text-sky-700 border-sky-300 bg-sky-50">
              ソース別
            </a>
          ) : (
            <a href={`${base}/page/source/1`} class="inline-block px-2 py-1 rounded border text-gray-400 hover:text-sky-600 hover:border-sky-200">
              ソース別
            </a>
          )}
        </div>
      </header>

      <!-- ページネーション（上） -->
      <nav class="mb-6 text-center space-x-2">
        {currentPage > 1 && (
          <a href={`${base}/page/${sort}/${currentPage - 1}`} class="inline-block px-4 py-2 border border-sky-600 text-sky-600 rounded hover:bg-gray-100 transition">
            ← 前のページ
          </a>
        )}
        {currentPage < totalPages && (
          <a href={`${base}/page/${sort}/${currentPage + 1}`} class="inline-block px-4 py-2 border border-sky-600 text-sky-600 rounded hover:bg-gray-100 transition">
            次のページ →
          </a>
        )}
      </nav>

      <!-- 一覧表示 -->
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {posts.map((post, index) => (
          <div>
            <a href={`${base}/posts/${post.slug}?fromPage=${currentPage}&fromSort=${sort}`} class="block bg-white rounded shadow hover:shadow-md transition">
              <div class="p-4">
                <h2 class="text-lg font-bold no-underline text-sky-400 hover:text-gray-500 line-clamp-2">
                  {post.data.title}
                </h2>
                <p class="text-sm text-gray-500 mt-2">
                  {post.data.source} / {new Date(post.data.pubDate).toLocaleDateString("ja-JP")}
                </p>
              </div>
            </a>
            {index < posts.length - 1 && <hr class="my-6 border-t border-gray-100" />}
          </div>
        ))}
      </div>

      <!-- ページネーション（下） -->
      <nav class="mt-10 text-center space-x-2">
        {currentPage > 1 && (
          <a href={`${base}/page/${sort}/${currentPage - 1}`} class="inline-block px-4 py-2 border border-sky-600 text-sky-600 rounded hover:bg-gray-100 transition">
            ← 前のページ
          </a>
        )}
        {currentPage < totalPages && (
          <a href={`${base}/page/${sort}/${currentPage + 1}`} class="inline-block px-4 py-2 border border-sky-600 text-sky-600 rounded hover:bg-gray-100 transition">
            次のページ →
          </a>
        )}
      </nav>

    </div>
  </body>
</html>