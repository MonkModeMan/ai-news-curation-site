---
// src/pages/page/[page].astro
// ✅ 修正版：ページ番号付きルート（/page/1 など）に対応
import { getCollection } from 'astro:content';
import ArticleCard from '../../components/ArticleCard.astro';

const PAGE_SIZE = 30;

// ✅ getStaticPaths（静的ページ生成）
export async function getStaticPaths() {
  const allPosts = await getCollection("posts");
  const totalPages = Math.ceil(allPosts.length / PAGE_SIZE);

  return Array.from({ length: totalPages }, (_, i) => ({
    params: { page: String(i + 1) },
  }));
}

// ✅ ページごとのデータ取得
const { page } = Astro.params;
const currentPage = parseInt(page);
const allPosts = await getCollection("posts");

// 新着順にソート
const sortedPosts = [...allPosts].sort(
  (a, b) => new Date(b.data.pubDate) - new Date(a.data.pubDate)
);

const totalPages = Math.ceil(sortedPosts.length / PAGE_SIZE);
const startIndex = (currentPage - 1) * PAGE_SIZE;
const currentPosts = sortedPosts.slice(startIndex, startIndex + PAGE_SIZE);
---

<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>AIニュース一覧 | ページ {page}</title>
  </head>
  <body class="bg-gray-50 font-sans">
    <main class="max-w-7xl mx-auto p-4">
      <h1 class="text-2xl font-bold mb-4">AIニュース一覧</h1>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {currentPosts.map(post => (
          <ArticleCard
            title={post.data.title}
            pubDate={post.data.pubDate}
            description={post.data.description}
            media={post.data.source}
            thumbnail={post.data.thumbnail}
            url={post.data.url}
          />
        ))}
      </div>

      <div class="flex justify-center items-center mt-10 gap-4">
        {currentPage > 1 && (
          <a href={`/page/${currentPage - 1}/`} class="text-blue-500 hover:underline">
            ← 前のページ
          </a>
        )}
        <span>Page {currentPage} / {totalPages}</span>
        {currentPage < totalPages && (
          <a href={`/page/${currentPage + 1}/`} class="text-blue-500 hover:underline">
            次のページ →
          </a>
        )}
      </div>
    </main>
  </body>
</html>
