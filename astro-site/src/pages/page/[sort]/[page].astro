---
import { getCollection } from 'astro:content';
import ArticleCard from '../../../components/ArticleCard.astro';

const PAGE_SIZE = 30;

export async function getStaticPaths() {
  const allPosts = await getCollection("posts");
  const sorts = ["date", "source"];
  const paths = [];

  for (const sort of sorts) {
    const sorted = sort === "source"
      ? [...allPosts].sort((a, b) => a.data.source.localeCompare(b.data.source))
      : [...allPosts].sort((a, b) => new Date(b.data.pubDate) - new Date(a.data.pubDate));

    const totalPages = Math.ceil(sorted.length / PAGE_SIZE);
    for (let i = 1; i <= totalPages; i++) {
      paths.push({ params: { sort, page: String(i) } });
    }
  }

  return paths;
}

export async function get({ params }) {
  const allPosts = await getCollection("posts");
  const sort = params.sort;
  const currentPage = parseInt(params.page || "1", 10);

  const sorted = sort === "source"
    ? [...allPosts].sort((a, b) => a.data.source.localeCompare(b.data.source))
    : [...allPosts].sort((a, b) => new Date(b.data.pubDate) - new Date(a.data.pubDate));

  const start = (currentPage - 1) * PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const pagePosts = sorted.slice(start, end);

  return {
    props: {
      posts: pagePosts,
      currentPage,
      totalPages: Math.ceil(sorted.length / PAGE_SIZE),
      sort,
    },
  };
}

const { posts, currentPage, totalPages, sort } = Astro.props;
---

<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>AIニュース一覧（{sort}） - ページ {currentPage}</title>
  </head>
  <body class="bg-white text-black">
    <main class="max-w-5xl mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold mb-6">AIニュース一覧（{sort}）</h1>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {posts.map(post => (
          <ArticleCard post={post} />
        ))}
      </div>

      <div class="mt-8 flex justify-center gap-4">
        {currentPage > 1 && (
          <a
            href={`/page/${sort}/${currentPage - 1}`}
            class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
          >
            ← 前のページ
          </a>
        )}
        {currentPage < totalPages && (
          <a
            href={`/page/${sort}/${currentPage + 1}`}
            class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
          >
            次のページ →
          </a>
        )}
      </div>
    </main>
  </body>
</html>
